var appendBikes,binx_api,binx_list_item,binx_widget_template,formatDates,getNearbyStolen,getSerialResponse,initializeBinxWidget,root_url,trim;root_url="https://binx-widget.herokuapp.com",binx_api="https://bikeindex.org/api/v1/bikes?widget_from="+document.domain+"&",Array.prototype.uniq=function(){var e,n,t,s,a,i;for(n={},e=s=0,a=this.length;a>=0?a>s:s>a;e=a>=0?++s:--s)n[this[e]]=this[e];i=[];for(e in n)t=n[e],i.push(t);return i},trim=function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},getSerialResponse=function(e){var n,t;return n=$("#search_serials").attr("data-target"),t=this,$.ajax({type:"GET",url:""+binx_api+"serial="+e,success:function(n){return n.serial_searched=e,t.appendBikes(n)}})},appendBikes=function(e,n){var t,s;return null==n&&(n=null),null!=n&&(t={data:e,time:n},localStorage.setItem("binx_rstolen",JSON.stringify(t))),$("#binx_list_container").html(Mustache.render(binx_list_item,e)),$("#binx_stolen_widget ul").css("max-height",$("#binx_stolen_widget").attr("data-height")),formatDates(),null==e.recent_results&&e.bikes.length>0?(s=e.bikes.length>19?" <span>(many found, showing first 20)</span>":" <span>("+e.bikes.length+" found)</span>",$("#binx_list_container .search-response-info").append(s)):void 0},formatDates=function(){var e,n,t,s,a,i,r,l,o;for(s=new Date,a=new Date,a.setDate(s.getDate()-1),a=a.toString().split(/\d{2}:/)[0],s=s.toString().split(/\d{2}:/)[0],l=$("#binx_list_container .date-stolen"),o=[],i=0,r=l.length;r>i;i++)n=l[i],n=$(n),t=new Date(Date.parse(n.text().trim())),e=t.toString().split(/\d{2}:/)[0],e===s&&(e="Today"),e===a&&(e="Yesterday"),o.push(n.text(e));return o},getNearbyStolen=function(e,n){var t;return null==n&&(n=[]),t=""+binx_api+"stolen=true&proximity="+e+"&proximity_radius=100",$.ajax({type:"GET",url:t,success:function(t){var s;return s=(new Date).getTime(),t.recent_results=!0,t.bikes=n.concat(t.bikes),e.length>0&&(t.location=e),t.bikes.length<6&&e.length>0?getNearbyStolen("",t.bikes):appendBikes(t,s)}})},initializeBinxWidget=function(e){var n,t,s;return Mustache.parse(binx_list_item),$("#binx_stolen_widget").html(Mustache.render(binx_widget_template,e.height)),$("#binx_search_form").submit(function(){return getSerialResponse($("#binx_search").val()),!1}),$("#binxformsubm_a").click(function(){return getSerialResponse($("#binx_search").val())}),e.norecent?!0:(t=!1,e.nocache||(n=localStorage.getItem("binx_rstolen"),s=(new Date).getTime(),null!=n&&n.length>0&&(n=JSON.parse(n),null!=n.time&&s-n.time<108e5&&(t=!0,appendBikes(n.data)))),t?void 0:getNearbyStolen(e.location))},$(document).ready(function(){var e,n,t,s,a,i,r;return e=$("#binx_stolen_widget"),t={location:null!=(s=e.attr("data-location"))?s:"",nocache:null!=(a=e.attr("data-nocache"))?a:!1,norecent:null!=(i=e.attr("data-norecent"))?i:!1},n=null!=(r=e.attr("data-height"))?r:400,n=parseInt(n,10)-41,e.attr("data-height",""+n+"px"),initializeBinxWidget(t)}),binx_widget_template='<link href="'+root_url+'styles.css" rel="stylesheet" type="text/css">\n<form class="topsearcher" id="binx_search_form">\n  <span class="spacing-span"></span>\n  <span class="top-stripe skinny-stripe"></span>\n  <span class="spacing-span"></span>\n  <span class="top-stripe fat-stripe"></span>\n  <span class="spacing-span"></span>\n  <span class="bottom-stripe fat-stripe"></span>\n  <span class="spacing-span"></span>\n  <span class="bottom-stripe skinny-stripe"></span>\n  <input id="binx_search" type="text" placeholder="Search for a serial number">\n  <input type="submit" id="binxformsubm">\n  <a href="#" class="subm" id="binxformsubm_a"><img src="'+root_url+"search.svg\"></a>\n</form>\n<div class='binxcontainer' id='binx_list_container'></div>",binx_list_item="{{#serial_searched}}\n  <h2 class=\"search-response-info\">Bikes with serial numbers matching <em>{{serial_searched}}</em></h2>\n{{/serial_searched}}\n<ul>\n  {{#bikes}}\n    <li class='{{#stolen}}stolen{{/stolen}}'>\n      {{#thumb}}\n         <a class='stolen-thumb' href='{{url}}' target=\"_blank\">\n          <img src='{{thumb}}'>\n        </a>\n      {{/thumb}}\n      <h4>\n        <a href='{{url}}' target=\"_blank\">{{title}}</a>\n      </h4>\n      {{#stolen}}\n        <p>\n          <span class='stolen-color'>Stolen</span> {{#stolen_record.location}}from {{stolen_record.location}} &mdash; {{/stolen_record.location}} <span class='date-stolen'>{{stolen_record.date_stolen}}\n        </p>\n      {{/stolen}}\n      <p>\n        Serial: <span class='serial-text'>{{serial}}</span>\n      </p>\n      {{^stolen}}\n        <p class=\"not-stolen\">Bike is not marked stolen</p>\n      {{/stolen}}\n    </li>\n  {{/bikes}}\n</ul>\n{{^bikes}}\n  <div class=\"binx-stolen-widget-list\">\n    {{#recent_results}}\n      <h2 class='search-fail'>\n        We're sorry! Something went wrong and we couldn't retrieve recent results!\n        <span>We're probably working on fixing this right now, send us an email at <a href=\"mailto:contact@bikeindex.org\">contact@bikeindex.org</a> if the problem persists</span>\n      </h2>\n    {{/recent_results}}\n    {{#serial_searched}}\n      <h2 class='search-fail'>\n        No bikes found on the Bike Index with a serial of <span class=\"search-query\">{{serial_searched}}</span>\n      </h2>\n    {{/serial_searched}}\n  </div>\n{{/bikes}}\n{{#recent_results}}\n  <div class=\"widget-info\">\n    Recent reported stolen bikes \n    {{#location}}\n      near <em>{{location}}</em>\n    {{/location}}\n  </div>\n{{/recent_results}}";